/*
The MIT License (MIT)

Copyright (c) 2014 Richard Cook

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.
*/
JSoop.define("Ramen",{singleton:true,id:(function(){var a=0;return function(b){a=a+1;return b+"-"+a}}())},function(){if(!JSoop.GLOBAL.Spine){JSoop.GLOBAL.Spine=Ramen}});JSoop.define("Ramen.util.Sortable",{isSortable:true,sortTarget:"items",isSorted:false,findInsertionIndex:function(c,g,d){var f=this,e=d||f[f.sortTarget],a=0,b=e.length-1,i,h;g=g||f.sortFn;while(a<=b){i=(a+b)>>1;h=g(c,e[i]);if(h>=0){a=i+1}else{if(h<0){b=i-1}}}return a},sort:function(a){var b=this;b[b.sortTarget].sort(a);b.isSorted=true;b.sortFn=a;b.afterSort(b,b[b.sortTarget])},clearSort:function(){var a=this;a.isSorted=false;delete a.sortFn},afterSort:JSoop.emptyFn});JSoop.define("Ramen.util.filter.Filter",{mixins:{configurable:"JSoop.mixins.Configurable"},constructor:function(a,b){var c=this;if(arguments.length===1){if(a.fn){b=a}else{if(JSoop.isFunction(a)){b={fn:a}}else{b={fn:c.createFilterFn(a),attributes:a}}}}else{b.attributes=a}c.initMixin("configurable",[b])},createFilterFn:function(b){var a=[];JSoop.iterate(b,function(d,c){a.push('item["'+c+'"] === attributes["'+c+'"]')});a="return "+a.join(" && ")+";";return new Function("item","attributes",a)},is:function(b){var a=this;return !!a.fn(b,a.attributes)}});JSoop.define("Ramen.util.filter.Filterable",{isFilterable:true,isFiltered:false,filterTarget:"items",filterType:"Ramen.util.filter.Filter",constructor:function(){var a=this;a.filters={}},addFilter:function(b,a){var d=this,c=b;if(JSoop.isString(c)){c={};c[b]=a}JSoop.iterate(c,function(f,e){var g=d.createFilter(f);d.filters[e]=g});d.filter()},removeFilter:function(a){var b=this;delete b.filters[a];b.filter()},createFilterFn:function(){var c=this,a=["true"],b;JSoop.iterate(c.filters,function(e,d){a.push('this.filters["'+d+'"].is(item)')});a="return "+a.join("&&")+";";b=new Function("item",a);return function(){return b.apply(c,arguments)}},filter:function(){var b=this,a;if(b.beforeFilter(b)===false){return}if(!b.isFiltered){b.unfilteredItems=b[b.filterTarget].slice()}b.currentFilter=b.createFilter({fn:b.createFilterFn()});a=b.runFilter(b.currentFilter);b.isFiltered=true;b[b.filterTarget]=a;b.afterFilter(b,a,b.unfilteredItems)},createFilter:function(a){var b=this;if(a.isFilter){return a}return JSoop.create(b.filterType,a)},runFilter:function(c){var d=this,b=[],a;if(d.isFiltered){a=d.unfilteredItems.slice()}else{a=d[d.filterTarget].slice()}JSoop.each(a,function(e){if(c.is(e)){b.push(e)}});return b},clearFilters:function(){var a=this;if(!a.isFiltered){return}a.isFiltered=false;a.currentFilter=null;a.filters={};a[a.filterTarget]=a.unfilteredItems;delete a.unfilteredItems;a.afterFilter(a,a[a.filterTarget],a[a.filterTarget])},find:function(a){var c=this,b=c.createFilter(a);return c.runFilter(b)},findFirst:function(b){var d=this,c=d.createFilter(b),a=d.runFilter(c);return a[0]},findLast:function(b){var d=this,c=d.createFilter(b),a=d.runFilter(c);return a[a.length-1]},beforeFilter:JSoop.emptyFn,afterFilter:JSoop.emptyFn});JSoop.define("Ramen.collection.List",{mixins:{configurable:"JSoop.mixins.Configurable",observable:"JSoop.mixins.Observable",pluginManager:"JSoop.mixins.PluginManager",filterable:"Ramen.util.filter.Filterable",sortable:"Ramen.util.Sortable"},isList:true,constructor:function(a,b){var c=this;c.items=[];c.initMixin("configurable",[b]);c.initMixin("observable");c.initMixin("pluginManager");c.initMixin("filterable");c.initMixin("sortable");if(a){c.add(a)}},add:function(a){var b=this;if(b.isSorted){b.addSorted(a);return}b.insert(a,b.items.length)},addSorted:function(a){var c=this,b=[];a=JSoop.toArray(a);JSoop.each(a,function(e){e=c.initItem(e);var d=c.findInsertionIndex(e);if(c.fireEvent("add:before",c,e,d)!==false){e=c.insertItem(e,d,c.items);b.push(e)}});c.fireEvent("add",c,b)},insert:function(a,b){var d=this,c=[];a=JSoop.toArray(a);JSoop.each(a,function(e){e=d.initItem(e);if(d.fireEvent("add:before",d,e,b)!==false){e=d.insertItem(e,b,d.items);b=b+1;c.push(e)}});d.fireEvent("add",d,c)},initItem:function(a){return a},insertItem:function(b,a,c){c.splice(a,0,b);return b},insertUnfilteredItem:function(c,a){var b=this;return b.insertItem(c,a,b.unfilteredItems)},remove:function(a){var b=this,c=[];a=JSoop.toArray(a);JSoop.each(a,function(e){var d=b.indexOf(e);e=b.at(d);if(d!==-1&&b.fireEvent("remove:before",b,e,d)!==false){b.removeAt(d);c.push(e)}});b.fireEvent("remove",b,c)},removeAt:function(a){this.items.splice(a,1)},removeAll:function(){var a=this,b;if(a.fireEvent("remove:all:before",a)===false){return}if(a.isFiltered){b=a.unfilteredItems}else{b=a.items}a.items=[];a.unfilteredItems=[];a.fireEvent("remove:all",a);a.fireEvent("remove",a,b)},indexOf:function(b){var a=this;return JSoop.util.Array.indexOf(a.items,b)},at:function(a){return this.items[a]},each:function(d,c){var f=this,a=f.items.slice(),b=0,e=a.length;c=c||f;for(;b<e;b=b+1){if(d.call(c,a[b],b)===false){return}}},find:function(a){var c=this,b=c.createFilter(a),d=[];c.each(function(e){if(b.is(e)){d.push(e)}});return d},findFirst:function(a){var c=this,b=c.createFilter(a),d;c.each(function(e){if(b.is(e)){d=e;return false}});return d},findLast:function(a){var b=this,c=b.find(a);if(c.length>0){return c.pop()}return undefined},getCount:function(){return this.items.length},afterSort:function(c,a){var b=this;b.fireEvent("sort",b,a)},afterFilter:function(d,b,a){var c=this;c.fireEvent("filter",c,b,a)},destroy:function(){var a=this;if(a.fireEvent("destroy:before")===false){return false}a.fireEvent("destroy",a);a.removeAllListeners();a.removeAllManagedListeners();a.destroyAllPlugins();a.removeAll()},onAddBefore:function(d,c,a){var b=this;if(b.isFiltered){if(b.isSorted){a=b.findInsertionIndex(c,b.sortFn,b.unfilteredItems)}else{a=b.unfilteredItems.length}b.insertUnfilteredItem(c,a);if(!b.currentFilter.is(c)){return false}}},onRemoveBefore:JSoop.emptyFn,onRemoveAll:JSoop.emptyFn,onDestroy:JSoop.emptyFn});JSoop.define("Ramen.collection.Dictionary",{extend:"Ramen.collection.List",isDictionary:true,constructor:function(){var a=this;a.keys=[];a.cache={};a.callParent(arguments)},indexOf:function(b){var a=this;if(JSoop.isPrimitive(b)){return a.indexOfKey(b)}return a.callParent(arguments)},insertItem:function(d,a,e){var c=this,b=c.getKey(d);if(e!==c.unfilteredItems){c.keys.splice(a,0,b);c.cache[b]=d}return c.callParent(arguments)},insertUnfilteredItem:function(d,a){var c=this,b=c.getKey(d);c.unfilteredKeys.splice(a,0,b);return c.callParent(arguments)},removeAt:function(a){var c=this,b=c.keys[a];c.keys.splice(a,1);delete c.cache[b];c.callParent(arguments)},onAddBefore:function(e,d,a){var c=this,b=c.getKey(d);if(c.indexOfKey(b)!==-1||c.callParent(arguments)===false){return false}},sort:function(a){var b=this;if(JSoop.isString(a)){a=b.createSortFn(a)}b.mixins.sortable.prototype.sort.apply(b,[a]);b.ids=[];JSoop.each(b.items,function(c){b.ids.push(b.getKey(c))})},afterFilter:function(){var a=this;a.unfilteredKeys=a.keys.slice();a.rebuildKeys();a.rebuildCache();a.callParent(arguments)},onRemoveAll:function(){var a=this;a.keys=[];a.unfilteredKeys=[];a.cache={}},has:function(a){return this.indexOf(a)!==-1},getKey:function(a){return a.id},indexOfKey:function(a){var b=this;return JSoop.util.Array.indexOf(b.keys,a)},get:function(a){return this.cache[a]},iterate:function(b,a){var d=this,c=d.keys.slice();a=a||d;d.each(function(f,e){return b.call(a,f,c[e])})},createSortFn:function(c,b){var a;if(JSoop.isString(c)){a=['var val1 = item1["'+c+'"]','    val2 = item2["'+c+'"];',"if (val1 "+((b==="desc")?">":"<")+" val2) {","   return -1;","}","if (val1 "+((b==="desc")?"<":">")+" val2) {","   return 1;","}","return 0;"];c=new Function("item1","item2",a.join("\n"))}return c},rebuildCache:function(){var a=this;a.cache={};a.iterate(function(c,b){a.cache[b]=c})},rebuildKeys:function(){var a=this;a.keys=[];a.each(function(b){a.keys.push(a.getKey(b))})}});JSoop.define("Ramen.data.association.Association",{mixins:{configurable:"JSoop.mixins.Configurable"},config:{required:["name","model","mapping",]},isAssociation:true,constructor:function(a){var b=this;b.initMixin("configurable",[a])},parse:function(c,b){var d=this,a,e,f;if(d.prepare){a=d.prepare;if(JSoop.isString(a)){a=c[a]}a.call(c,b)}e=d.getData(b);f=d.createModels(c,e);d.assignModels(c,f)},getData:function(a){var b=this;return JSoop.objectQuery(b.mapping,a)},createModel:function(b){var a=this;if(b.isModel){return b}return JSoop.create(a.model,b)},createAssociationChangeListener:function(a){var b=this;return function(){a.fireEvent("change:association",a,b.name,a["get"+b.name]())}},createModels:JSoop.emptyFn,assignModels:JSoop.emptyFn});JSoop.define("Ramen.data.association.HasMany",{extend:"Ramen.data.association.Association",getData:function(){var a=this,b=a.callParent(arguments);if(!b){b=[]}return JSoop.toArray(b)},createModels:function(a,c){var b=this,d=[];JSoop.each(c,function(f){f[b.foreignKey]=a.get(a.idField);var e=b.createModel(f);e["get"+a.name]=function(){return a};d.push(e)});return d},assignModels:function(b,f){var c=this,e="get"+c.name,d,a;if(!b[e]){d=JSoop.create(c.collectionType||"Ramen.data.Collection",[],{model:c.model});b[e]=function(){return d};a=c.createAssociationChangeListener(b);b.mon(d,{add:a,remove:a,filter:a,sort:a,scope:b})}else{d=b[e]()}d.add(f);if(c.globalCollection){Ramen.getCollection(c.globalCollection).add(f)}}});JSoop.define("Ramen.data.association.HasOne",{extend:"Ramen.data.association.Association",createModels:function(a,d){var c=this,b;if(!d){if(a["get"+c.name]){d=a["get"+c.name]().attributes}else{d={}}}d[c.foreignKey]=a.get("id");b=c.createModel(d);return b},assignModels:function(c,e){var d=this,a="get"+d.name,b;if(c[a]){b=c["get"+d.name]()}c[a]=function(){return e};if(b){c.moff(b,"change")}c.mon(e,"change",d.createAssociationChangeListener(c),c)}});JSoop.define("Ramen.data.filter.ModelFilter",{extend:"Ramen.util.filter.Filter",createFilterFn:function(b){var a=[];JSoop.iterate(b,function(d,c){a.push('item.get("'+c+'") === attributes["'+c+'"]')});a="return "+a.join(" && ")+";";return new Function("item","attributes",a)}});JSoop.define("Ramen.data.Field",{mixins:{configurable:"JSoop.mixins.Configurable"},config:{required:["name"],defaults:{type:"auto"}},statics:{types:{bool:function(a){return !!a},"int":function(a){return parseInt(a,10)},"float":function(a){return parseFloat(a)},auto:function(a){return a}}},isField:true,constructor:function(a){var b=this;if(!JSoop.isObject(a)){a={name:a}}b.initMixin("configurable",[a]);if(!b.mapping){b.mapping=b.name}},read:function(d,a){var b=this,c=JSoop.objectQuery(b.mapping,d);if(c===undefined&&d){c=d[b.name]}return b.parse(c,d,a)},parse:function(d,c,a){var b=this;if(d===undefined){d=b.defaultValue}d=Ramen.data.Field.types[b.type](d);if(b.convert){d=b.convert(d,a,c)}return d}});JSoop.define("Ramen.data.Model",{mixins:{configurable:"JSoop.mixins.Configurable",observable:"JSoop.mixins.Observable"},config:{required:["fields","name"]},isModel:true,idField:"id",onExtended:function(c,a){var b=a.onBeforeCreated;a.onBeforeCreated=function(f,d){var e=this,g=(JSoop.objectQuery("Ramen.data.Model"))?Ramen.data.Model:f.statics;b.call(e,f,d);g.initFields.call(e);g.initAssociations.call(e)}},statics:{initFields:function(){var e=this,d=(e.prototype)?e.prototype:e.$class.prototype,g=d.superClass.prototype,f=(d.hasOwnProperty("fields"))?d.fields:[],b=g.fields,a=(b)?b.slice():[],c=d.fieldCache={};a=a.concat(f);JSoop.each(a,function(i,h){if(!i.isField){i=JSoop.create("Ramen.data.Field",i)}c[i.name]=i;a[h]=i});d.fields=a},initAssociations:function(){var e=this,c=(e.prototype)?e.prototype:e.$class.prototype,f=c.superClass.prototype,a=(c.hasOwnProperty("associations"))?c.associations:[],b=f.associations,d=(b)?b.slice():[];d=d.concat(a);JSoop.each(d,function(g,h){var i;if(!g.isAssociation){switch(g.type){case"hasMany":i="HasMany";break;case"hasOne":i="HasOne";break}g=JSoop.create("Ramen.data.association."+i,g)}d[h]=g});c.associations=d},addFields:function(a){var b=this;b.fields=b.fields.slice();b.fieldCache=JSoop.clone(b.fieldCache);JSoop.each(a,function(c){if(!c.isField){c=JSoop.create("Ramen.data.Field",c)}b.fields.push(c);b.fieldCache[c.name]=c})}},constructor:function(d,b){var c=this,a;if(b){a=b.fields;delete b.fields}c.initMixin("configurable",[b]);c.initMixin("observable");c.attributes={};if(a){Ramen.data.Model.addFields.call(c,a)}if(d){c.set(d)}},get:function(a){return this.attributes[a]},getId:function(){var a=this;return a.get(a.idField)},set:function(g,f){var d=this,e={},b=g,c={},a={};if(!JSoop.isObject(b)){b={};b[g]=f}if(d.getId()===undefined&&b[d.idField]===undefined){b[d.idField]=""}b=JSoop.apply(JSoop.clone(d.attributes),b);JSoop.each(d.fields,function(i){var h=i.read(b,d);if(h!==undefined){e[i.name]=h}});JSoop.iterate(e,function(i,j){var h=d.get(j);d.attributes[j]=i;d.fireEvent("change:"+j,d,i,h);if(h!==i){a[j]=h;c[j]=i}});d.parseAssociations(b);d.fireEvent("change",d,a,c)},parseAssociations:function(a){var c=this,b=c.associations;if(!b){return}JSoop.each(b,function(d){d.parse(c,a)})}});JSoop.define("Ramen.data.Query",{constructor:function(d,c){var a=this,b=d;if(!JSoop.isObject(b)){b={};b[d]=c}a.data=b;a.createFn()},createFn:function(){var b=this,a=[];JSoop.iterate(b.data,function(c,d){a.push('model.get("'+d+'") === data["'+d+'"]')});b.fn=new Function("model","data","return "+a.join("&&")+";")},is:function(a){var b=this;return b.fn(a,b.data)}});JSoop.define("Ramen.data.Collection",{extend:"Ramen.collection.Dictionary",filterType:"Ramen.data.filter.ModelFilter",config:{required:["model"]},getKey:function(a){return a.get(a.idField)},initItem:function(a){return this.create(a)},createSortFn:function(c,b){var a;if(JSoop.isString(c)){a=['var val1 = model1.get("'+c+'"),','    val2 = model2.get("'+c+'");',"if (val1 "+((b==="desc")?">":"<")+" val2) {","   return -1;","}","if (val1 "+((b==="desc")?"<":">")+" val2) {","   return 1;","}","return 0;"];c=new Function("model1","model2",a.join("\n"))}return c},onAddBefore:function(d,c,a){var b=this;if(b.callParent(arguments)===false){a=b.indexOfKey(b.getKey(c));if(a!==-1){b.items[a].set(c.mergeData);delete c.mergeData}return false}else{delete c.mergeData}},isCollection:true,create:function(b){var a=this;if(b.isModel){return b}return JSoop.create(a.model,b,{mergeData:b})}},function(){Ramen.collections={};Ramen.addCollection=function(a,b){Ramen.collections[a]=b};Ramen.getCollection=function(a){return Ramen.collections[a]}});JSoop.define("Ramen.app.Application",{mixins:{configurable:"JSoop.mixins.Configurable"},constructor:function(a){var b=this;b.initMixin("configurable",[a]);b.initCollections();b.initControllers();b.run();Ramen.app.History.start()},initCollections:function(){var a=this;a.collections=a.collections||{};JSoop.iterate(a.collections,function(c,b){if(!c.isCollection){c=JSoop.create(c)}Ramen.addCollection(b,c)})},initControllers:function(){var a=this;a.controllers=a.controllers||{};JSoop.iterate(a.controllers,function(c,b){if(JSoop.isString(c)){c={type:c}}c.app=a;a.controllers[b]=JSoop.create(c.type,c)})},run:JSoop.emptyFn},function(){Ramen.application=function(a){if(a.requires){JSoop.Loader.require(a.requires)}JSoop.create("Ramen.app.Application",a)}});JSoop.define("Ramen.app.Controller",{mixins:{configurable:"JSoop.mixins.Configurable"},constructor:function(a){var b=this;b.initMixin("configurable",[a]);b.queries={};b.controlling=[];Ramen.view.ViewManager.on("add",b.onViewAdd,b);b.initController();b.initHelpers();b.initRouter()},initController:JSoop.emptyFn,initHelpers:function(){var b=this,a=b.helpers;b.helpers={};if(a){JSoop.iterate(a,function(d,c){if(JSoop.isString(d)){d={type:d}}d.owner=b;b.helpers[c]=JSoop.create(d.type,d)})}},initRouter:function(){var a=this;a.routes=a.routes||{};a.router=JSoop.create("Ramen.app.Router",{listeners:{route:a.onRouterRoute,scope:a}});JSoop.iterate(a.routes,function(c,b){a.router.add(b)})},getApp:function(){return this.app},control:function(a){var b=this;JSoop.iterate(a,function(d,c){b.controlling.push({selector:c,events:d,query:Ramen.view.Query.parse(c)})})},navigate:function(a){Ramen.app.History.navigate(a)},onViewAdd:function(b,a){var c=this;JSoop.each(c.controlling,function(d){JSoop.each(a,function(e){if(d.query.is(e)){e.on(d.events)}})})},onRouterRoute:function(b,d,a){var c=this,e=c.routes[d];if(!e){return}if(JSoop.isString(e)){e={fn:e}}JSoop.applyIf(e,{scope:c});if(JSoop.isString(e.scope)){e.scope=c.helpers[e.scope]}if(JSoop.isString(e.fn)){e.fn=e.scope[e.fn]}return e.fn.apply(e.scope,a.getParams(Ramen.app.History.getFragment()))}});JSoop.define("Ramen.app.Helper",{mixins:{configurable:"JSoop.mixins.Configurable",observable:"JSoop.mixins.Observable"},constructor:function(a){var b=this;b.initMixin("configurable",[a]);b.initMixin("observable");b.initHelper()},getApp:function(){return this.owner.app},initHelper:JSoop.emptyFn});JSoop.define("Ramen.app.History",{mixins:{observable:"JSoop.mixins.Observable"},singleton:true,isStarted:false,interval:50,constructor:function(){var a=this;a.initMixin("observable")},start:function(){var c=this,b,d,a;if(c.isStarted){return}c.isStarted=true;b=document.documentMode;d=(/msie [\w.]+/.exec(navigator.userAgent.toLowerCase())&&(!b||b<=7));if(d){c.createFrame();c.navigate(c.getFragment())}a=JSoop.bind(c.checkUrl,c);if(("onhashchange" in window)&&!d){jQuery(window).on("hashchange",a)}else{c.checkUrlInterval=setInterval(a,c.interval)}a()},createFrame:function(){var a=this,b=Ramen.dom.Helper.create({tag:"iframe",src:"javascript:0",tabindex:"-1"});a.iframe=b.hide().appendTo("body")[0].contentWindow},navigate:function(b){var c=this,a;if(!c.isStarted){return}if(JSoop.isString(b)){b={fragment:b}}JSoop.applyIf(b,{silent:false,replace:false});a=b.fragment.replace(/#.*$/,"");if(c.fragment===a){return}c.fragment=a;c.updateFragment(b.fragment,b.replace);if(!b.silent){c.fireEvent("change",a)}},updateFragment:(function(){function a(b,c,d){if(d){b.replace(b.href.replace(/(javascript:|#).*$/,"")+"#"+c)}else{b.hash="#"+c}}return function(c,d){var f=this,b=window.location,g,e;a(b,c,d);if(f.frame){e=f.frame.location;g=f.getHash(f.frame);g=f.getFragment(g);if(c!==g){if(!d){f.frame.document.open().close()}a(e,c,b)}}}}()),getFragment:function(a){var b=this;if(!a){a=b.getHash()}return a.replace(/^[#\/]|\s+$/g,"")},getHash:function(b){var a=(b||window).location.href.match(/#(.*)$/);return a?a[1]:""},checkUrl:function(){var a=this,b=a.getFragment();if(b===a.fragment&&a.frame){b=a.getFragment(a.getHash(a.frame))}if(b===a.fragment){return false}a.fragment=b;if(a.frame){a.navigate(b)}a.loadUrl();return true},loadUrl:function(){var b=this,a=b.getFragment();b.fireEvent("change",a)}});JSoop.define("Ramen.app.Route",{mixins:{configurable:"JSoop.mixins.Configurable"},isRoute:true,constructor:function(a){var b=this;b.initMixin("configurable",[a]);if(!b.name){b.name=b.route}b.initRoute()},initRoute:(function(){var c=/\((.*?)\)/g,b=/(\(\?)?:\w+/g,d=/\*\w+/g,a=/[\-{}\[\]+?.,\\\^$|#\s]/g;return function(){var f=this,e=f.route;if(!JSoop.isRegExp(e)){e=e.replace(a,"\\$&").replace(c,"(?:$1)?").replace(b,function(h,g){return g?h:"([^/?]+)"}).replace(d,"([^?]*?)");f.route=new RegExp("^"+e+"(?:\\?([\\s\\S]*))?$")}}}()),is:function(a){var b=this;return b.route.test(a)},getParams:function(a){var b=this,c=b.route.exec(a).slice(1),d=[];JSoop.each(c,function(f,e){f=f||null;if(e===c.length-1){d.push(f);return}if(f!==null){f=decodeURIComponent(f)}d.push(f)});return d}});JSoop.define("Ramen.app.Router",{mixins:{configurable:"JSoop.mixins.Configurable",observable:"JSoop.mixins.Observable"},isRouter:true,constructor:function(b){var c=this,a;c.initMixin("configurable",[b]);c.initMixin("observable");a=c.routes;c.routes={};if(JSoop.isArray(a)){JSoop.each(a,function(d){c.add(d)})}c.initRouter();Ramen.app.History.on("change",c.onHistoryChange,c)},initRouter:JSoop.emptyFn,add:function(a){var c=this,b=Ramen.app.History.getFragment();if(JSoop.isString(a)){a={route:a}}if(!a.isRoute){JSoop.applyIf(a,{type:"Ramen.app.Route"});a=JSoop.create(a.type,a)}c.routes[a.name]=a;if(a.is(b)){c.fireEvent("route",a.route,a)}},remove:function(a){delete this.routes[a]},onHistoryChange:function(a){var c=this,b=false;JSoop.iterate(c.routes,function(d,e){if(d.is(a)){if(c.fireEvent("route",c,e,d)===false){b=true;return false}}});if(b){return false}}});JSoop.define("Ramen.util.Renderable",{isRenderable:true,createEl:function(){return Ramen.dom.Helper.create(this.getTagConfig())},getTagConfig:function(){var c=this,b=JSoop.toArray(c.cls||[]),a;b.push(c.baseCls);if(JSoop.isString(c.tag)){a={tag:c.tag}}else{a=JSoop.clone(c.tag||{})}JSoop.applyIf(a,{tag:"div",id:c.getId(),cls:b,style:c.style||{}});return a},getTemplate:function(b){var c=this,a=c[b];if(a.isTemplate){return a}c[b]=JSoop.create("Ramen.util.Template",a);return c[b]},initChildSelectors:function(){var c=this,b=c.renderSelectors||{},a=c.childSelectors||{};JSoop.iterate(b,function(d,e){c[e]=jQuery(d,c.el)});JSoop.iterate(a,function(d,e){c[e]=jQuery(d,c.el)})},initChildEls:function(){var b=this,c=b.getId(),a=b.childEls||{};JSoop.iterate(a,function(d,e){b[e]=jQuery("#"+c+"-"+d,b.el)})},addCls:function(a){var b=this;a=JSoop.toArray(a);if(!b.el){if(!b.cls){b.cls=[]}else{b.cls=JSoop.toArray(b.cls)}JSoop.each(a,function(c){if(JSoop.util.Array.indexOf(b.cls,c)===-1){b.cls.push(c)}});return}JSoop.each(a,function(c){b.el.addClass(c)})},removeCls:function(a){var b=this;a=JSoop.toArray(a);if(!b.el){if(!b.cls){return}else{b.cls=JSoop.toArray(b.cls)}JSoop.each(a,function(c){index=JSoop.util.Array.indexOf(b.cls,c);if(index!==-1){b.cls.splice(index,1)}});return}JSoop.each(a,function(c){b.el.removeClass(c)})},});JSoop.define("Ramen.util.Template",{isTemplate:true,constructor:function(a){var b=this;if(JSoop.isArray(a)){a=a.join("")}b.raw=a;b.initTemplate()},initTemplate:function(){var a=this;a.tpl=Twig.twig({data:a.raw})},render:function(a){return this.tpl.render(a)}});JSoop.define("Ramen.dom.Helper",{singleton:true,singletonRegEx:/^(br|hr|img|input|link|meta|param)$/,unitlessRegEx:/^(font-weight|z-index)$/,create:function(a){return jQuery(Ramen.dom.Helper.markup(a))},markup:function(a){var c=this,b=["<"+a.tag];JSoop.iterate(a,function(e,d){switch(d){case"html":return;case"children":return;case"tag":return;case"cls":d="class";e=JSoop.toArray(e).join(" ");break;case"style":e=Ramen.dom.Helper.parseStyle(e);break}b.push(d+'="'+e+'"')});if(Ramen.dom.Helper.singletonRegEx.test(a.tag)){b.push("/>")}else{if(a.html){b.push(">"+a.html+"</"+a.tag+">")}else{if(a.children){b.push(">");JSoop.each(a.children,function(d){b.push(c.markup(d))});b.push("</"+a.tag+">")}else{b.push("></"+a.tag+">")}}}return b.join(" ")},addUnits:function(a,b){if(JSoop.isNumber(b)&&!this.unitlessRegEx.test(a)){b=b+"px"}return b},parseStyle:function(c){var b=this,a=[];if(JSoop.isString(c)){return c}JSoop.iterate(c,function(e,d){if(JSoop.isObject(e)){JSoop.iterate(e,function(f,g){a.push(d+"-"+g+":"+b.addUnits(e))})}else{a.push(d+":"+b.addUnits(d,e))}});return a.join(";")}});JSoop.define("Ramen.view.Box",{mixins:{configurable:"JSoop.mixins.Configurable",observable:"JSoop.mixins.Observable",pluginManager:"JSoop.mixins.PluginManager",renderable:"Ramen.util.Renderable"},rtype:"box",isBox:true,isManaged:true,autoRender:false,tag:null,config:{required:["baseId","baseCls"]},constructor:function(a){var b=this;b.initMixin("configurable",[a]);b.initMixin("observable");b.initMixin("pluginManager");b.initView();b.id=b.getId();b.el=b.createEl();if(b.isManaged){Ramen.view.ViewManager.add(b)}if(b.autoRender){b.render(b.renderTo)}},initView:JSoop.emptyFn,getId:function(){var a=this;if(!a.id){a.id=Ramen.id(a.baseId)}return a.id},render:function(a,b){var c=this;if(c.fireEvent("render:before",c,a,b)===false){return}c.fireEvent("render:during",c);c.addToContainer(a,b);c.isRendered=true;if(c.owner&&!c.owner.isRendered){c.mon(c.owner,"render:after",function(){c.fireEvent("render:after",c)},c,{single:true})}else{c.fireEvent("render:after",c)}},addToContainer:function(a,b){var c=this;if(!a){a=c.renderTo}a=jQuery(a).eq(0);if(b===undefined||!a[0].childNodes[b]){a.append(c.el)}else{a=a[0];a.insertBefore(c.el[0],a.childNodes[b])}},destroy:function(){var a=this;if(a.fireEvent("destroy:before")===false){return false}a.fireEvent("destroy",a);a.removeAllListeners();a.removeAllManagedListeners();a.destroyAllPlugins();a.el.remove();if(a.isManaged){Ramen.view.ViewManager.remove(a)}},onDestroyBefore:JSoop.emptyFn,onDestroy:JSoop.emptyFn,onRenderDuring:JSoop.emptyFn,onRenderBefore:JSoop.emptyFn,onRenderAfter:JSoop.emptyFn});JSoop.define("Ramen.view.View",{extend:"Ramen.view.Box",isView:true,rtype:"view",tpl:"",baseCls:"view",baseId:"view",initView:function(){var a=this;a.renderData=a.renderData||{};a.callParent(arguments)},initRenderData:function(b){var a=this;JSoop.applyIf(b,{id:a.getId(),baseCls:a.baseCls});return b},onRenderDuring:function(){var c=this,d=c.initRenderData(c.renderData),a=c.getTemplate("tpl"),b=a.render(d);c.el.html(b);c.initChildSelectors();c.initChildEls();c.initDomListeners()},addDomListener:function(b,a,c){if(c.single){c.callFn=function(){var d=c.fn.apply(c.scope,arguments);b.unbind(a,c.callFn);return d}}b.bind(a,c.callFn)},initDomListener:function(a,c,d){var b=this;if(!JSoop.isObject(c)){c={fn:c}}if(JSoop.isString(c.fn)){c.fn=b[c.fn]}JSoop.applyIf(c,d||{});JSoop.applyIf(c,{scope:b});c.fn=c.callFn=JSoop.bind(c.fn,c.scope);return c},initDomListeners:function(){var b=this,a=b.domListeners||{};JSoop.iterate(a,function(d,e){var c={};JSoop.iterate(d,function(g,f){if(f==="single"||f==="scope"){c[f]=g}});JSoop.iterate(d,function(g,f){if(f==="single"||f==="scope"){return}g=JSoop.toArray(g);JSoop.each(g,function(h){h=b.initDomListener(f,h,c);b.addDomListener(b[e],f,h)})})})},destroy:function(){var c=this,b=c.renderSelectors||{},a=c.childEls||{};JSoop.iterate(b,function(d,e){c[e].off();c[e]=null});JSoop.iterate(a,function(d,e){c[e].off();c[e]=null});c.callParent()}});(function(){var b={op:/^[>^]$/,bool:/^(true|false)$/,selector:/^([^[]+)(\[(.+?)=(.+?)])?$/,term:/\s/},a=function(c){var d=this;d.raw=c;d.tree=[];d.parse()};a.prototype={parse:function(){var g=this,e=g.raw.replace(/^\s+|\s+$/g,""),d=e.split(""),f="",h=false,i;while(d.length){i=d.shift();if(b.term.test(i)&&!h){if(f.length>0){g.processToken(f);f=""}}else{f=f+i;if(i==='"'||i==="'"){if(h&&h===i){h=false}else{if(!h){h=i}}}}}if(f.length>0){g.processToken(f)}},processToken:function(c){var d=this;if(b.op.test(c)){d.addOp(c)}else{if(b.selector.test(c)){d.addSelector(c)}else{JSoop.error('Selector improperly formed "'+d.raw.trim()+'"')}}},addOp:function(d){var c=this;c.tree.push(d)},addSelector:function(c){var h=this,d=b.selector.exec(c),f=d[1],g=d[3],i=d[4],e=["if (view.rtype !== '"+f+"') { return false; }"];if(g&&!i){e.push("if (!view['"+g+"']) { return false; }")}if(g&&i){e.push("if (view['"+g+"'] !== "+i+") { return false; }")}e.push("return true;");e=new Function("view",e.join("\n"));h.tree.push(e)},is:function(d){var h=this,g=d,c="",j=false,f=h.tree[h.tree.length-1],e;if(!f(g)){return false}for(e=h.tree.length-2;e>=0;e=e-1){f=h.tree[e];if(JSoop.isFunction(f)){g=g.owner;if(!g){return false}if(c===""){j=false;do{if(!f(g)){g=g.owner}else{j=true;break}}while(g);if(!j){return false}}else{if(c===">"){if(!f(g)){return false}}}c=""}else{c=f}}return true},execute:function(){var e=this,d=Ramen.view.Manager,c=[];d.each(function(f){if(e.is(f)){c.push(f)}});return c}};JSoop.define("Ramen.view.Query",{singleton:true,parse:function(c){return new a(c)},is:function(d,c){var e=new a(c);return e.is(d)}})}());JSoop.define("Ramen.view.ViewManager",{extend:"Ramen.collection.Dictionary",singleton:true,getKey:function(a){return a.getId()}});JSoop.define("Ramen.view.binding.Binding",{mixins:{configurable:"JSoop.mixins.Configurable",observable:"JSoop.mixins.Observable",renderable:"Ramen.util.Renderable"},isBinding:true,baseCls:"binding",tpl:"{{ content }}",constructor:function(a){var b=this;b.initMixin("configurable",[a]);b.initMixin("observable");b.initBinding();if(b.owner){b.attach()}},attach:function(){var a=this;a.mon(a.owner,{"render:before":a.onOwnerRenderBefore,"render:during":a.onOwnerRenderDuring,scope:a,single:true})},initBinding:JSoop.emptyFn,getId:function(){var a=this;if(!a.id){a.id=Ramen.id("binding")}return a.id},getHtml:function(){var b=this,a=b.getTagConfig();a.html=b.getContent();return Ramen.dom.Helper.markup(a)},getContent:function(){var a=this,b=a.getRenderData();if(!JSoop.isObject(b)){b={content:b}}JSoop.applyIf(b,{id:a.getId(),baseCls:a.baseCls});return a.getTemplate("tpl").render(b)},getRenderData:function(){return""},update:function(){var a=this;setTimeout(function(){a.el.html(a.getContent())},0)},destroy:function(){var a=this;a.removeAllListeners();a.removeAllManagedListeners()},onOwnerRenderBefore:function(a){var b=this;a.renderData[b.token]=b.getHtml()},onOwnerRenderDuring:function(){var a=this;a.el=a.owner.el.find("#"+a.getId());a.initChildSelectors();a.initChildEls();a.update()}});JSoop.define("Ramen.view.binding.ModelBinding",{extend:"Ramen.view.binding.Binding",isModelBinding:true,watchingFields:null,watchingAssociations:null,initBinding:function(){var a=this;if(JSoop.isString(a.model)){a.model=a.owner[a.model]}if(a.field){a.formatter=new Function("model",'return model.get("'+a.field+'");')}a.parseWatchers();a.mon(a.model,"change",a.onChange,a);a.mon(a.model,"change:association",a.onAssociationChange,a)},getRenderData:function(){var a=this;return a.formatter(a.model,a.owner)},parseWatchers:function(){var d=this,c=[],b=d.formatter.toString(),e=/\.get\(["'](.+?)["']\)/g,a;if(!d.watchingFields){d.watchingFields=[]}if(!d.watchingAssociations){d.watchingAssociations=[]}for(a=e.exec(b);a;a=e.exec(b)){if(JSoop.util.Array.indexOf(c,a[1])===-1){c.push(a[1])}}d.watchingFields=d.watchingFields.concat(c);e=/\.get([A-Z][a-zA-Z0-9]*)\(.*\)/g;c=[];for(a=e.exec(b);a;a=e.exec(b)){if(JSoop.util.Array.indexOf(c,a[1])===-1){c.push(a[1])}}d.watchingAssociations=d.watchingAssociations.concat(c)},onChange:function(b,a){var c=this,d=false;JSoop.each(c.watchingFields,function(e){if(a.hasOwnProperty(e)){d=true;return false}});if(d){c.update()}},onAssociationChange:function(b,a){var c=this;if(JSoop.util.Array.indexOf(c.watchingAssociations,a)!==-1){c.update()}}});JSoop.define("Ramen.view.binding.BindingView",{extend:"Ramen.view.View",render:function(){var a=this;a.initBindings();a.callParent(arguments)},initBindings:function(){var b=this,c=JSoop.clone(b.bindings||{}),a=b.getModel();b.bindings={};JSoop.iterate(c||{},function(f,e){var d;if(JSoop.isString(f)){f={field:f}}else{if(JSoop.isFunction(f)){f={formatter:f}}}d=f.model||a;if(JSoop.isString(d)){d=JSoop.getValue(b[d],b)}if(!f.isBinding){JSoop.applyIf(f,{type:"Ramen.view.binding.ModelBinding",token:e,owner:b});f.model=d;f=JSoop.create(f.type,f)}else{f.owner=b;f.model=d;f.attach()}b.bindings[e]=f})},getModel:function(){return this.model},onDestroy:function(){var a=this;JSoop.iterate(a.bindings,function(b){b.destroy()});a.callParent(arguments)}});JSoop.define("Ramen.view.layout.Layout",{extend:"Ramen.view.Box",isLayout:true,isManaged:false,baseCls:"layout",baseId:"layout",wrapperTag:null,wrapperCls:"",constructor:function(){var a=this;a.callParent(arguments);a.initLayout();a.itemCache=JSoop.create("Ramen.collection.Dictionary",null,{getKey:function(b){return b.getId()},listeners:{add:a.onItemsAdd,remove:a.onItemsRemove,sort:a.onItemsSort,scope:a}});a.mon(a.owner.items,{add:a.onOwnerItemsAdd,remove:a.onOwnerItemsRemove,sort:a.onOwnerItemsSort,scope:a});a.mon(a.owner,{"render:during":a.renderItems,"render:after":a.doLayout,scope:a,single:true});a.wrapperCache={}},initLayout:JSoop.emptyFn,initContainer:JSoop.emptyFn,doLayout:function(){var a=this;if(a.fireEvent("layout:before",a)===false){return}a.fireEvent("layout:during",a);a.fireEvent("layout:after",a)},add:function(a){var b=this;b.itemCache.add(a)},insert:function(a,b){var c=this;c.itemCache.insert(a,b)},remove:function(a){var b=this;b.itemCache.remove(a)},renderItems:function(){var a=this;if(!a.needsRender){return}a.initContainer();a.itemCache.each(function(d,b){var c=a.getItemId(d),e=a.createWrapper(d,b);a.wrapperCache[c]=e;d.render(e)})},getItemId:function(a){return this.itemCache.getKey(a)},createWrapper:function(f,c){var e=this,a=JSoop.clone(e.wrapperTag||{tag:"div"}),d=e.getWrapperClasses(f,c),b=e.owner.getTargetEl(),g;if(JSoop.isString(a)){a={tag:a}}JSoop.applyIf(a,{cls:d,style:e.getWrapperStyle(f,c)});g=Ramen.dom.Helper.create(a);if(c===undefined||!b[0].childNodes[c]){b.append(g)}else{b=b[0];b.insertBefore(g[0],b.childNodes[c])}return g},getWrapperClasses:function(c){var b=this,a=[b.wrapperCls];if(c.wrapperCls){a=a.concat(JSoop.toArray(c.wrapperCls))}return a},getWrapperStyle:function(c){var a={},b=["width","height","padding","margin"];JSoop.each(b,function(d){if(c[d]!==undefined){a[d]=c[d]}});JSoop.apply(a,c.wrapperStyle||{});return a},getWrapperEl:function(b){var a=this;return a.wrapperCache[a.getItemId(b)]},destroy:function(){var a=this;if(a.callParent(arguments)!==false){a.itemCache.removeAll()}},onItemsAdd:function(c,a){var b=this;if(!b.owner.isRendered){b.needsRender=true;return}JSoop.each(a,function(f){var e=b.getItemId(f),d=b.itemCache.indexOf(f),g=b.createWrapper(f,d);b.wrapperCache[e]=g;f.render(g)});b.doLayout()},onItemsRemove:function(c,b){var a=this;JSoop.each(b,function(e){var d=a.getItemId(e),f=a.wrapperCache[d];delete a.wrapperCache[d];f.remove();e.destroy()});a.doLayout()},onItemsSort:function(){var b=this,a=b.owner.getTargetEl();b.itemCache.each(function(e,c){var d=b.getItemId(e),f=b.wrapperCache[d];if(c===undefined||!a[0].childNodes[c]){a.append(f)}else{a[0].insertBefore(f[0],a[0].childNodes[c])}});b.doLayout()},onOwnerItemsAdd:function(c,a){var b=this;JSoop.each(a,function(e){var d=c.indexOf(e);b.itemCache.insert(e,d)})},onOwnerItemsRemove:function(b,a){this.itemCache.remove(a)},onOwnerItemsSort:function(){var a=this;a.itemCache.sort(a.owner.items.sortFn)},onLayoutBefore:JSoop.emptyFn,onLayoutDuring:JSoop.emptyFn,onLayoutAfter:JSoop.emptyFn});JSoop.define("Ramen.view.layout.NoLayout",{extend:"Ramen.view.layout.Layout",renderItems:function(){var a=this;if(!a.needsRender){return}a.initContainer();a.itemCache.each(function(d,b){var c=a.getItemId(d),e=a.createWrapper(d,b);a.wrapperCache[c]=e;d.render(a.owner.getTargetEl())})},createWrapper:function(a){return a.el},onItemsAdd:function(c,a){var b=this;if(!b.owner.isRendered){b.needsRender=true;return}JSoop.each(a,function(f){var e=b.getItemId(f),d=b.itemCache.indexOf(f),g=b.createWrapper(f,d);b.wrapperCache[e]=g;f.render(b.owner.getTargetEl(),d)})}});JSoop.define("Ramen.view.container.Container",{extend:"Ramen.view.View",isContainer:true,rtype:"container",baseCls:"container",baseId:"container",layout:"Ramen.view.layout.Layout",targetEl:null,initView:function(){var b=this,a=b.items;b.callParent(arguments);b.items=JSoop.create("Ramen.collection.Dictionary",null,{getKey:function(c){return c.getId()}});b.initLayout();if(a){b.add(a)}},initLayout:function(){var b=this,a=JSoop.clone(b.layout||{});if(JSoop.isString(a)){a={type:a}}JSoop.applyIf(a,b.layout||{});JSoop.applyIf(a,{type:"Ramen.view.layout.Layout"});a.owner=b;b.layout=JSoop.create(a.type,a);b.mon(b.layout,{"layout:before":function(){return b.fireEvent("layout:before",b)},"layout:during":function(){b.fireEvent("layout:during",b)},"layout:after":function(){b.fireEvent("layout:after",b)},scope:b})},initItems:function(a){var b=this;a=JSoop.toArray(a);JSoop.each(a,function(d,c){d=b.initItem(d);if(!d){return}a[c]=d});return a},initItem:function(b){var a=this;if(b.isBox){b.owner=a;return b}JSoop.applyIf(b,JSoop.clone(a.itemDefaults||{}));JSoop.applyIf(b,{type:"Ramen.view.View"});b.owner=a;b=JSoop.create(b.type,b);return b},getTargetEl:function(){var a=this;if(a.targetEl&&a[a.targetEl]){return a[a.targetEl]}return a.el},add:function(a){var b=this;a=b.initItems(a);b.items.add(a)},remove:function(a){this.items.remove(a)},insert:function(a,b){var c=this;a=c.initItems(a);c.items.insert(a,b)},onDestroy:function(){var a=this;a.items.removeAll();a.layout.destroy();a.callParent(arguments)},find:function(c){var a=this,b=[];c=Ramen.view.Query.parse(c);a.items.each(function(d){if(c.is(d)){b.push(d)}});return b},findFirst:function(b){var a=this;return a.find(b).shift()},findLast:function(b){var a=this;return a.find(b).pop()},doLayout:function(){this.layout.doLayout()},onLayoutBefore:JSoop.emptyFn,onLayoutDuring:JSoop.emptyFn,onLayoutAfter:JSoop.emptyFn});JSoop.define("Ramen.view.container.CollectionContainer",{extend:"Ramen.view.container.Container",rtype:"collection-container",suppressEmptyView:false,initView:function(){var a=this;a.items=JSoop.clone(a.collection.items);a.itemCache={};a.callParent(arguments);a.initEmptyView();a.mon(a.collection,{add:a.onCollectionAdd,remove:a.onCollectionRemove,sort:a.onCollectionSort,filter:a.onCollectionFilter,scope:a})},initItem:function(b){var a=this;b={model:b};b=a.callParent([b]);a.itemCache[a.collection.getKey(b.model)]=b;return b},onDestroy:function(){var a=this;a.callParent(arguments);a.emptyView=null},initEmptyView:function(){var b=this,a;if(!b.emptyView){return}if(!b.emptyView.isBox){a=JSoop.clone(b.emptyView);a=Ramen.view.container.Container.prototype.initItem.call(b,a);b.emptyView=a}b.mon(b.emptyView,"render:during",b.hideEmptyView,b,{single:true});b.items.add(a)},showEmptyView:function(){var a=this;if(!a.emptyView){return}a.emptyView.el.show()},hideEmptyView:function(){var a=this;if(!a.emptyView){return}a.emptyView.el.hide()},createItemSortFn:function(){var a=this,b=a.collection;return function(d,c){return b.sortFn(d.model,c.model)}},onCollectionAdd:function(c,a){var b=this;JSoop.each(a,function(e){var d=c.indexOf(e);b.insert(e,d)});b.hideEmptyView()},onCollectionRemove:function(c,b){var a=this;JSoop.each(b,function(e){var d=c.getKey(e);a.items.remove(a.itemCache[d]);delete a.itemCache[d]});if(c.getCount()===0&&!a.suppressEmptyView){a.showEmptyView()}},onCollectionSort:function(){var a=this;a.items.sort(a.createItemSortFn())},onCollectionFilter:function(f,b,a){var d=this,e=[],c=[];JSoop.each(a,function(g){if(f.indexOf(g)===-1){e.push(g)}});f.iterate(function(g,h){if(!d.itemCache[h]){c.push(g)}});if(e.length>0){d.onCollectionRemove(f,e)}if(c.length>0){d.onCollectionAdd(f,c)}if(f.getCount()===0&&!d.suppressEmptyView){d.showEmptyView()}else{d.hideEmptyView()}}});JSoop.define("Ramen.view.container.Viewport",{extend:"Ramen.view.container.Container",rtype:"viewport",baseId:"viewport",baseCls:"viewport",replace:function(a){var b=this;b.items.removeAll();b.add(a)}});